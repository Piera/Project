<!DOCTYPE html>
<html>
    
    <head>

        <title> Home Page </title>
        <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='stylesheet.css') }}"> 
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.js"></script>
        <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3&sensor=true"></script>
        <!-- This is for Google Maps Geocode.  Will move this to a js file in static folder -->
        <script>
        var geocoder;
        var map;
        var lat;
        var lng;
        $(document).ready(function() {
        
          initialize();

          $("#find_snow").click(function() {
            var address = $("#address").val();
            geocoder.geocode( { 'address': address}, function(results, status) {
              if (status == google.maps.GeocoderStatus.OK) {
                map.setCenter(results[0].geometry.location);
                map.setZoom(8);
                var marker = new google.maps.Marker({
                    map: map,
                    position: results[0].geometry.location
                    });
            } else {
                alert('Geocode was not successful for the following reason: ' + status);
              }
             //  Piera's code starts here
              var lat = results[0].geometry.location.lat();
              var lng = results[0].geometry.location.lng();
              console.log(lat, lng);

              $.post(
                "/report",
                {
                  lat: lat,
                  lng: lng
                },
                function (response) {
                  console.log(response['closest'][2]['lat']);
                  // var marker = {};
                  // console.log(response);
                  //$("#snow_report").html(response);
                  // var positions = [];
                function getCircle(depth) {
                                return {
                                  path: google.maps.SymbolPath.CIRCLE,
                                  fillColor: 'blue',
                                  fillOpacity: .7,
                                  // scale: Math.pow(2.2, depth) / Math.PI,
                                  scale: depth*10/1.5,
                                  strokeColor: 'blue',
                                  strokeWeight: .9
                                };
                            }

                  for (var i in response['closest'])
                  {
                    // $('#snow_report').html("this is deep: " + response[i].depth + "<br>");
                    console.log(response['closest'][i]['lat'],response['closest'][i]['lng']);
                    var coordinates = new google.maps.LatLng(response['closest'][i]['lat'],response['closest'][i]['lng']);
                    var marker_depth = response['closest'][i]['depth'];
                    console.log(marker_depth);
                    console.log(getCircle(marker_depth));
                    // // positions.push(coordinates);
                    console.log(coordinates);
                    marker = new google.maps.Marker
                      ({
                    map: map,
                    position: coordinates,
                    icon: getCircle(marker_depth)
                     });
                  }

                  $('#snow_report').html("<br><h4>Snow Report:</h4><ul><li>The two stations closest to this location are the " + response['closest'][0]['name'] + " station that is " + response['closest'][0]['dist'] + " miles away, with " + response['closest'][0]['depth'] + " inches of snow, and the " + response['closest'][1]['name'] + " station that is " + response['closest'][1]['dist'] + " miles away, with " + response['closest'][1]['depth'] + " inches of snow.</li></ul>").addClass( "snow" );

                  $('#snow_report').append(
                    "<ul><li>Of these 10 closest stations, the stations reading most snow pack are the " + response['deepest'][0]['name'] + " station that is " + response['deepest'][0]['dist'] + " miles away, with " + response['deepest'][0]['depth'] + " inches of snow, and the " + response['deepest'][1]['name'] + " station that is " + response['deepest'][1]['dist'] + " miles away, with " + response['deepest'][1]['depth'] + " inches of snow.</li></ul>")

                  $('#snow_report').append(
                    "<ul><li>The stations with the most new snow are the " + response['most new'][0]['name'] + " station that is " + response['most new'][0]['dist'] + " miles away, with " + response['most new'][0]['depth'] + " inches of total snow, including " + response['most new'][0]['depth_change'] + " inches of new snow, and the " + response['most new'][1]['name'] + " station that is " + response['most new'][1]['dist'] + " miles away, with " + response['most new'][1]['depth'] + " inches of total snow, including " + response['most new'][0]['depth_change'] + " inches of new snow.</li></ul><br>")

                },
                "json"
              );
              // Piera's code ends
            });
          });
        });

        function initialize() {
          geocoder = new google.maps.Geocoder();
          var latlng = new google.maps.LatLng(38.48323, -109.2896);
          var mapOptions = {
            zoom: 5,
            center: latlng,
            mapTypeId: google.maps.MapTypeId.TERRAIN

          }
          map = new google.maps.Map($('#map-canvas').get(0), mapOptions);
        }
        
        </script>

    </head>

    <body>

        <h4>Enter Location:</h4>
        <div id="panel">
            <input id="address" size="100" type="textbox" value="Echo Lake, CA">
            <input type="button" value="Snow Report" id="find_snow">
        </div>
        <div id="map-canvas"></div>
        <div id="snow_report"></div>

    </body>

</html>