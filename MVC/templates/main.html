<!DOCTYPE html>
<html>
    
    <head>

        <title> Home Page </title>
        <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='stylesheet.css') }}"> 
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.js"></script>
        <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3&sensor=true"></script>
        <!-- This is for Google Maps Geocode.  Will move this to a js file in static folder -->
        <script>
        var geocoder;
        var map;
        var lat;
        var lng;
        var positions = [];
        $(document).ready(function() {
        
          initialize();

          $("#find_snow").click(function() {
            clearAllMap(map);
            var address = $("#address").val();
            geocoder.geocode( { 'address': address}, function(results, status) {
              if (status == google.maps.GeocoderStatus.OK) {
                map.setCenter(results[0].geometry.location);
                map.setZoom(8);
                var marker = new google.maps.Marker({
                    map: map,
                    position: results[0].geometry.location
                    });
                positions.push(marker);
            } else {
                alert('Geocode was not successful for the following reason: ' + status);
              }
             //  Piera's code starts here
              var lat = results[0].geometry.location.lat();
              var lng = results[0].geometry.location.lng();
              console.log(lat, lng);

              $.post(
                "/report",
                {
                  lat: lat,
                  lng: lng
                },
                function (response) {
                  console.log(response['closest'][2]['lat']);
                  function getCircle(depth) {
                                return {
                                  path: google.maps.SymbolPath.CIRCLE,
                                  fillColor: 'blue',
                                  fillOpacity: .5,
                                  // scale: Math.pow(2.2, depth) / Math.PI,
                                  scale: depth*10/1.5,
                                  strokeColor: 'blue',
                                  strokeWeight: .7
                                };
                            }
                  for (var i in response['closest'])
                  {
                    // $('#snow_report').html("this is deep: " + response[i].depth + "<br>");
                    console.log("Coordinates: " + response['closest'][i]['lat'],response['closest'][i]['lng']);
                    var coordinates = new google.maps.LatLng(response['closest'][i]['lat'],response['closest'][i]['lng']);
                    var marker_depth = response['closest'][i]['depth'];
                    console.log("Marker_depth: " + marker_depth);
                    // positions.push(coordinates);
                    marker = new google.maps.Marker
                      ({
                    map: map,
                    position: coordinates,
                    icon: getCircle(marker_depth)
                     });
                    positions.push(marker);
                  }
                  console.log("Positions array: " + positions);

                  $('#snow_report').html("<br><h4>Snow Report:</h4><ul><li><h5>The two stations closest to this location are the " + response['closest'][0]['name'] + " station that is " + response['closest'][0]['dist'] + " miles away, with " + response['closest'][0]['depth'] + " inches of snow, and the " + response['closest'][1]['name'] + " station that is " + response['closest'][1]['dist'] + " miles away, with " + response['closest'][1]['depth'] + " inches of snow.</li></ul></h5>")

                  $('#snow_report').append(
                    "<ul><li><h5>Of these 10 closest stations, the stations reading most snow pack are the " + response['deepest'][0]['name'] + " station that is " + response['deepest'][0]['dist'] + " miles away, with " + response['deepest'][0]['depth'] + " inches of snow, and the " + response['deepest'][1]['name'] + " station that is " + response['deepest'][1]['dist'] + " miles away, with " + response['deepest'][1]['depth'] + " inches of snow.</h5></li></ul>")

                  $('#snow_report').append(
                    "<ul><li><h5>The stations with the most new snow are the " + response['most new'][0]['name'] + " station that is " + response['most new'][0]['dist'] + " miles away, with " + response['most new'][0]['depth'] + " inches of total snow, including " + response['most new'][0]['depth_change'] + " inches of new snow, and the " + response['most new'][1]['name'] + " station that is " + response['most new'][1]['dist'] + " miles away, with " + response['most new'][1]['depth'] + " inches of total snow, including " + response['most new'][0]['depth_change'] + " inches of new snow.</h5></li></ul><br>")

                },
                "json"
              );
              // Piera's code ends
            });
          });
        });

        function clearAllMap(map) {
          if (positions) 
          {
            for (var i = 0; i < positions.length; i++) 
              {
                positions[i].setMap(null)
                console.log("Positions: " + positions[i])
              }
              positions = [];
              } else 
              {
              console.log("hi Piera");
              }
          }

        function initialize() {
         var styles = [
                {
              featureType: "all",
              stylers: [
                { saturation: -80 }
              ]
            },{
              featureType: "road.arterial",
              elementType: "geometry",
              stylers: [
                { hue: "#00ffee" },
                { saturation: 70 }
              ]
            },{
              featureType: "poi.business",
              elementType: "labels",
              stylers: [
                { visibility: "off" }
              ]
            }
              ];

        var styledMap = new google.maps.StyledMapType(styles,
             {name: "Styled Map"});
          geocoder = new google.maps.Geocoder();
          var latlng = new google.maps.LatLng(38.48323, -109.2896);
          var mapOptions = {
            zoom: 5,
            center: latlng,
            mapTypeControlOptions: 
             {
            mapTypeId: [google.maps.MapTypeId.TERRAIN, 'map_style']
             },
            disableDefaultUI: true,
            panControl: false,
            zoomControl: true,
            scaleControl: false,
            mapTypeControl: true

          }
          map = new google.maps.Map($('#map-canvas').get(0), mapOptions);
          map.mapTypes.set('map_style', styledMap);
          map.setMapTypeId('map_style');
        }
        
        </script>

    </head>

    <body>

        <div id="panel">
          <form role="form" class="form-inline">
            <form class ="form-group">
            <label for="inputLocation" class="addressInput"><h4>Enter Location:   </h4></label>
            <input id="address" size="50" type="textbox" class="form-control" value="Lake Aloha, CA">
            <input type="button" class="btn btn-primary" value="Snow Report" id="find_snow">
          </form>
        </div>

        <div class="row">
            <div class="col-md-8">
              <div id="map-canvas"></div>
            </div>
            <div class="col-md-4">
              <div id="snow_report"></div>
            </div>
        </div>

      <!--   <div id="map-canvas"></div>
        <div id="snow_report"></div> -->

    </body>

</html>